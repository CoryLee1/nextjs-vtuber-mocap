# R3F Canvas 持久化重构 - 测试检查清单

## ✅ 构建状态

- [x] 项目编译成功
- [x] 无 TypeScript 错误
- [x] 开发服务器已启动

---

## 🧪 功能测试清单

### 1. Canvas 持久化测试

#### 1.1 基础渲染
- [ ] 页面加载后，3D 场景正常显示
- [ ] Canvas 背景色为 `#0036FF`
- [ ] VRM 模型正常加载和显示
- [ ] 网格地板正常显示
- [ ] 光照系统正常工作

#### 1.2 路由切换测试
- [ ] 切换到其他页面（如 `/subscription`）
- [ ] 检查 Canvas 是否仍然存在（在 layout 层级）
- [ ] 返回主页面，检查场景是否保持
- [ ] 检查 WebGL 上下文是否未丢失
- [ ] 检查模型是否重新加载（应该不重新加载）

**预期结果：**
- Canvas 在路由切换时保持
- WebGL 上下文不丢失
- 模型不重新加载（使用缓存）

---

### 2. 模型缓存测试

#### 2.1 模型加载
- [ ] 首次加载模型时，控制台显示 "模型已缓存到 store"
- [ ] 检查 store 中 `vrmModel` 和 `vrmModelUrl` 是否正确设置

#### 2.2 模型切换
- [ ] 切换到不同模型
- [ ] 检查旧模型是否正确释放（控制台显示 "释放旧模型"）
- [ ] 检查新模型是否正确缓存
- [ ] 检查场景中显示的模型是否正确更新

#### 2.3 组件重新挂载
- [ ] 刷新页面
- [ ] 检查模型是否从缓存加载（如果 URL 相同）
- [ ] 检查是否显示加载指示器

**预期结果：**
- 模型切换时旧模型正确释放
- 新模型正确缓存
- 相同 URL 的模型不重复加载

---

### 3. MediaPipe 动捕测试

#### 3.1 摄像头启动
- [ ] 点击摄像头按钮启动摄像头
- [ ] 检查 `canvasReady` 状态是否为 `true`
- [ ] 检查摄像头预览窗口是否显示
- [ ] 检查 MediaPipe 是否正常初始化

#### 3.2 动捕数据流
- [ ] 检查 `resultsCallback` 是否正确注册到 store
- [ ] 检查 `resultsCallback` 是否正确注册到 `useVideoRecognition`
- [ ] 检查 VRM 模型是否响应面部动捕
- [ ] 检查 VRM 模型是否响应身体动捕
- [ ] 检查 VRM 模型是否响应手部动捕

#### 3.3 数据流中断测试
- [ ] 切换路由后返回
- [ ] 检查动捕数据流是否继续正常
- [ ] 检查回调是否仍然有效

**预期结果：**
- 动捕数据流完全正常
- 路由切换后数据流不中断
- 所有动捕功能（面部、身体、手部）正常

---

### 4. 场景状态管理测试

#### 4.1 场景切换
- [ ] 检查 `activeScene` 初始值是否为 `'main'`
- [ ] 测试场景切换功能（如果有其他场景）
- [ ] 检查场景切换时是否平滑

#### 4.2 状态同步
- [ ] 检查模型选择是否同步到 store
- [ ] 检查动画选择是否同步到 store
- [ ] 检查调试设置是否同步到 store
- [ ] 检查相机设置是否同步到 store

**预期结果：**
- 所有状态正确同步到 store
- 场景切换流畅

---

### 5. 性能测试

#### 5.1 开发环境性能监控
- [ ] 检查左上角是否显示 `r3f-perf` 性能监控
- [ ] 检查 FPS 是否稳定（目标 ≥ 30 FPS）
- [ ] 检查是否有性能警告

#### 5.2 内存管理
- [ ] 切换模型多次
- [ ] 检查是否有内存泄漏
- [ ] 检查旧模型资源是否正确释放

**预期结果：**
- FPS 稳定在 30+ FPS
- 无内存泄漏
- 资源正确释放

---

### 6. UI 组件测试

#### 6.1 控制面板
- [ ] 检查控制面板功能是否正常
- [ ] 检查摄像头开关是否正常
- [ ] 检查骨骼显示开关是否正常
- [ ] 检查调试模式开关是否正常

#### 6.2 模型管理器
- [ ] 打开模型管理器
- [ ] 选择模型
- [ ] 检查模型是否正确切换
- [ ] 检查 store 中的 URL 是否正确更新

#### 6.3 动画库
- [ ] 打开动画库
- [ ] 选择动画
- [ ] 检查动画是否正确切换
- [ ] 检查 store 中的动画 URL 是否正确更新

**预期结果：**
- 所有 UI 组件功能正常
- 状态正确同步

---

## 🐛 已知问题和注意事项

### 1. 调试面板
- `ArmDebugPanel` 等调试组件可能需要从 store 读取引用
- 如果调试面板不显示，检查引用传递是否正确

### 2. 模型加载时机
- 首次加载可能需要等待 Canvas ready
- 如果模型不显示，检查 `canvasReady` 状态

### 3. MediaPipe 回调
- 回调同时注册到 `useVideoRecognition` 和场景 store
- 如果动捕不工作，检查两个注册是否都成功

---

## 📝 测试结果记录

### 测试环境
- 浏览器：_____________
- 操作系统：_____________
- 测试时间：_____________

### 测试结果

#### Canvas 持久化
- [ ] 通过
- [ ] 失败（问题：_____________）

#### 模型缓存
- [ ] 通过
- [ ] 失败（问题：_____________）

#### MediaPipe 动捕
- [ ] 通过
- [ ] 失败（问题：_____________）

#### 场景状态管理
- [ ] 通过
- [ ] 失败（问题：_____________）

#### 性能
- [ ] 通过
- [ ] 失败（问题：_____________）

#### UI 组件
- [ ] 通过
- [ ] 失败（问题：_____________）

---

## 🔧 故障排除

### 问题 1：Canvas 不显示
**可能原因：**
- Canvas3DProvider 未正确添加到 layout
- z-index 设置导致被遮挡

**解决方案：**
1. 检查 `src/app/[locale]/layout.tsx` 中是否有 `Canvas3DProvider`
2. 检查浏览器控制台是否有错误
3. 检查 Canvas div 的样式是否正确

### 问题 2：模型不加载
**可能原因：**
- 模型 URL 未同步到 store
- Canvas 未就绪

**解决方案：**
1. 检查 `canvasReady` 状态
2. 检查 store 中的 `vrmModelUrl`
3. 检查控制台是否有加载错误

### 问题 3：动捕不工作
**可能原因：**
- `resultsCallback` 未正确注册
- `videoElement` 未正确传递

**解决方案：**
1. 检查 `resultsCallback` 是否注册到 store
2. 检查 `CameraWidget` 是否正确传递 `videoElement`
3. 检查 MediaPipe 初始化是否成功

### 问题 4：路由切换后场景丢失
**可能原因：**
- Canvas3DProvider 位置不正确
- 场景状态未正确管理

**解决方案：**
1. 检查 Canvas3DProvider 是否在 layout 层级
2. 检查 `activeScene` 状态是否正确
3. 检查场景是否使用 `visible` 属性而非条件渲染

---

## ✅ 验收标准

所有测试通过后，重构成功：

1. ✅ Canvas 在 layout 层级，路由切换时不重建
2. ✅ VRM 模型缓存正常工作，切换模型时旧模型正确释放
3. ✅ MediaPipe 动捕功能完全正常
4. ✅ 所有 UI 组件功能正常
5. ✅ 性能无明显下降（FPS ≥ 30）
6. ✅ 无内存泄漏
7. ✅ 代码结构清晰，易于维护

---

## 📊 性能基准

### 重构前
- 路由切换：Canvas 重建，模型重新加载
- 模型切换：直接加载新模型
- FPS：_____________（如果已知）

### 重构后（目标）
- 路由切换：Canvas 保持，模型不重新加载
- 模型切换：旧模型释放，新模型缓存
- FPS：≥ 30 FPS

---

## 🎯 下一步

测试完成后：
1. 记录测试结果
2. 修复发现的问题
3. 优化性能（如有需要）
4. 更新文档



