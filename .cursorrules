# VTuber Motion Capture Project - Code Rules

## ğŸ¯ é¡¹ç›®æ ¸å¿ƒåŸåˆ™

### æ•°æ®æµæ¶æ„
```
Camera â†’ MediaPipe â†’ Kalidokit â†’ VRM Model
                                    â†“
                            Coordinate Normalization
```

**å•å‘æ•°æ®æµ**ï¼šçŠ¶æ€åªèƒ½å‘ä¸‹ä¼ é€’ï¼Œé¿å…å¾ªç¯ä¾èµ–
**æ€§èƒ½ä¼˜å…ˆ**ï¼šåŠ¨æ•éœ€è¦ 60fpsï¼Œæ‰€æœ‰ä»£ç å¿…é¡»è€ƒè™‘æ€§èƒ½å½±å“
**å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šUIã€3D æ¸²æŸ“ã€æ•°æ®å¤„ç†ä¸¥æ ¼åˆ†ç¦»

---

## ğŸ“ ç›®å½•ç»“æ„è§„èŒƒ

```
src/
â”œâ”€â”€ app/                      # Next.js App Router
â”‚   â”œâ”€â”€ [locale]/            # å›½é™…åŒ–è·¯ç”±
â”‚   â””â”€â”€ layout.tsx           # æ ¹å¸ƒå±€
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ dressing-room/       # ä¸»åŠŸèƒ½ç»„ä»¶ï¼ˆUI å±‚ï¼‰
â”‚   â”‚   â”œâ”€â”€ VTuberApp.tsx        # ä¸»åº”ç”¨å®¹å™¨
â”‚   â”‚   â”œâ”€â”€ VTuberLayout.tsx     # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ VTuberControls.tsx   # æ§åˆ¶é¢æ¿
â”‚   â”‚   â””â”€â”€ ModelManager.tsx     # æ¨¡å‹ç®¡ç†å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ three/               # Three.js ä¸“ç”¨ç»„ä»¶ï¼ˆ3D å±‚ï¼‰
â”‚   â”‚   â”œâ”€â”€ VRMAvatar3D.tsx      # VRM æ¸²æŸ“ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ Scene3D.tsx          # 3D åœºæ™¯å®¹å™¨
â”‚   â”‚   â””â”€â”€ Camera3D.tsx         # 3D ç›¸æœº
â”‚   â”‚
â”‚   â”œâ”€â”€ debug/               # è°ƒè¯•å·¥å…·ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ CoordinateDebugPanel.tsx
â”‚   â”‚   â”œâ”€â”€ PerformanceMonitor.tsx
â”‚   â”‚   â””â”€â”€ VRMInspector.tsx     # VRM æ¨¡å‹æ£€æŸ¥å™¨ï¼ˆæ–°ï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ ui/                  # é€šç”¨ UI ç»„ä»¶
â”‚       â”œâ”€â”€ OnboardingGuide.tsx
â”‚       â””â”€â”€ shadcn components...
â”‚
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ use-camera-stream.ts     # æ‘„åƒå¤´æµç®¡ç†
â”‚   â”œâ”€â”€ use-mocap-pipeline.ts    # åŠ¨æ•æ•°æ®å¤„ç†ç®¡é“
â”‚   â”œâ”€â”€ use-vrm-model.ts         # VRM æ¨¡å‹åŠ è½½å’Œç®¡ç†
â”‚   â”œâ”€â”€ use-vrm-normalizer.ts    # VRM åæ ‡å½’ä¸€åŒ–ï¼ˆæ–°ï¼‰
â”‚   â””â”€â”€ use-coordinate-system.ts # åæ ‡ç³»æ£€æµ‹å’Œè½¬æ¢ï¼ˆæ–°ï¼‰
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ mocap/               # åŠ¨æ•æ ¸å¿ƒé€»è¾‘
â”‚   â”‚   â”œâ”€â”€ processors/
â”‚   â”‚   â”‚   â”œâ”€â”€ PoseProcessor.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ HandProcessor.ts
â”‚   â”‚   â”‚   â””â”€â”€ FaceProcessor.ts
â”‚   â”‚   â””â”€â”€ pipeline.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ vrm/                 # VRM å¤„ç†é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ loader.ts            # VRM åŠ è½½å™¨
â”‚   â”‚   â”œâ”€â”€ normalizer.ts        # åæ ‡å½’ä¸€åŒ–å™¨ï¼ˆæ–°ï¼‰
â”‚   â”‚   â”œâ”€â”€ inspector.ts         # æ¨¡å‹æ£€æŸ¥å™¨ï¼ˆæ–°ï¼‰
â”‚   â”‚   â””â”€â”€ coordinate-fixer.ts  # åæ ‡ä¿®å¤å·¥å…·ï¼ˆæ–°ï¼‰
â”‚   â”‚
â”‚   â””â”€â”€ utils/               # é€šç”¨å·¥å…·
â”‚       â”œâ”€â”€ coordinate-transform.ts
â”‚       â””â”€â”€ performance.ts
â”‚
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ mocap.ts             # åŠ¨æ•ç›¸å…³ç±»å‹
â”‚   â”œâ”€â”€ vrm.ts               # VRM ç›¸å…³ç±»å‹
â”‚   â”œâ”€â”€ coordinate.ts        # åæ ‡ç³»ç±»å‹ï¼ˆæ–°ï¼‰
â”‚   â””â”€â”€ ui.ts                # UI ç›¸å…³ç±»å‹
â”‚
â””â”€â”€ config/
    â”œâ”€â”€ axis-mapping.ts      # åæ ‡æ˜ å°„é…ç½®ï¼ˆå¯èƒ½åºŸå¼ƒï¼‰
    â”œâ”€â”€ vrm-defaults.ts      # VRM é»˜è®¤é…ç½®ï¼ˆæ–°ï¼‰
    â””â”€â”€ coordinate-systems.ts # æ”¯æŒçš„åæ ‡ç³»å®šä¹‰ï¼ˆæ–°ï¼‰
```

---

## ğŸ¨ ä»£ç ç»„ç»‡è§„åˆ™

### 1. æ€§èƒ½å…³é”®ä»£ç ï¼ˆåŠ¨æ•å¾ªç¯ï¼‰

**ä½ç½®**ï¼š`lib/mocap/processors/`  
**å‘½å**ï¼š`*Processor.ts`ï¼ˆå¦‚ `PoseProcessor.ts`ï¼‰

**è¦æ±‚**ï¼š
```typescript
// âœ… å¥½çš„åšæ³•
class PoseProcessor {
  private poseCache = { x: 0, y: 0, z: 0 }; // å¤ç”¨å¯¹è±¡
  
  // PERF: ä½¿ç”¨å¯¹è±¡æ± é¿å… GC å‹åŠ›
  process(data: MediaPipeData): TransformedPose {
    this.poseCache.x = data.x;
    this.poseCache.y = data.y;
    this.poseCache.z = data.z;
    return this.poseCache;
  }
}

// âŒ é¿å…çš„åšæ³•
function processPose(data: MediaPipeData): TransformedPose {
  return { ...data }; // æ¯å¸§åˆ›å»ºæ–°å¯¹è±¡ï¼
}
```

**å¿…é¡»åŒ…å«**ï¼š
- å¯¹è±¡æ± æ¨¡å¼
- æ€§èƒ½æ³¨é‡Š `// PERF: ...`
- é¿å…åœ¨å¾ªç¯ä¸­åˆ›å»ºå¯¹è±¡
- æœ€å°åŒ–æ¡ä»¶åˆ†æ”¯

---

### 2. VRM æœå‘ä¿®å¤ï¼ˆé‡è¦ï¼‰

**ä½ç½®**ï¼š`components/dressing-room/VRMAvatar.tsx`  
**ç›®çš„**ï¼šå¤„ç† VRM 0.x å’Œ VRM 1.0 çš„æœå‘å·®å¼‚

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
```typescript
import { VRMUtils } from '@pixiv/three-vrm';

// âœ… æ¨èåšæ³•ï¼šä½¿ç”¨åº“è‡ªå¸¦çš„è§£å†³æ–¹æ¡ˆ
// VRM 0.x: è§„èŒƒè¦æ±‚é¢æœ -Zï¼ˆå‘å±å¹•å¤–ï¼‰
// VRM 1.0: è§„èŒƒæ”¹ä¸ºé¢æœ +Zï¼ˆå‘å±å¹•å†…ï¼‰
// å¦‚æœä»£ç å‡è®¾æ˜¯ VRM 1.0ï¼ŒåŠ è½½ VRM 0.x å°±ä¼šçœ‹åˆ°åèƒŒ
VRMUtils.rotateVRM0(vrm); // â† è¿™ä¸€è¡Œå°±å¤Ÿäº†ï¼
```

**ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸ªé—®é¢˜**ï¼š
- **VRM 0.x**: è§„èŒƒè¦æ±‚é¢æœ -Zï¼ˆå‘å±å¹•å¤–ï¼‰
- **VRM 1.0**: è§„èŒƒæ”¹ä¸ºé¢æœ +Zï¼ˆå‘å±å¹•å†…ï¼‰

**å®ç°ä½ç½®**ï¼š
åœ¨ `VRMAvatar.tsx` çš„ VRM åˆå§‹åŒ– `useEffect` ä¸­ï¼Œåœ¨è°ƒç”¨å…¶ä»– `VRMUtils` å‡½æ•°ä¹‹å‰ï¼š

```typescript
// åˆå§‹åŒ– VRM æ¨¡å‹
useEffect(() => {
  if (!vrm) return;

  // âœ… ä¿®å¤ VRM 0.x å’Œ VRM 1.0 çš„æœå‘å·®å¼‚
  VRMUtils.rotateVRM0(vrm);

  // VRM ä¼˜åŒ–
  VRMUtils.removeUnnecessaryVertices(scene);
  VRMUtils.combineSkeletons(scene);
  VRMUtils.combineMorphs(vrm);
  
  // ... å…¶ä»–åˆå§‹åŒ–ä»£ç 
}, [vrm, scene]);
```

**é‡è¦è¯´æ˜**ï¼š
- `axis-mapping.ts` é…ç½®**ä¸æ˜¯**ç”¨æ¥ä¿®å¤æ¨¡å‹æœå‘çš„
- `axisSettings` æ˜¯ç”¨æ¥è½¬æ¢åŠ¨æ•æ•°æ®åˆ° VRM éª¨éª¼æ—‹è½¬çš„
- å¦‚æœé€šè¿‡æ˜ å°„æ¥"ä¿®å¤"æœå‘ï¼Œé‚£æ˜¯åœ¨æ©ç›–é—®é¢˜
- **æ¨èåšæ³•**ï¼šä½¿ç”¨ `VRMUtils.rotateVRM0(vrm)` è¿™ä¸ªåº“è‡ªå¸¦çš„è§£å†³æ–¹æ¡ˆ

---

### 3. Three.js ç»„ä»¶è§„èŒƒ

**ä½ç½®**ï¼š`components/three/`  
**å‘½å**ï¼š`*3D.tsx`ï¼ˆå¦‚ `VRMAvatar3D.tsx`ï¼‰

**è¦æ±‚**ï¼š
```typescript
// âœ… å¿…é¡»ä½¿ç”¨ memo å’Œ ä¼˜åŒ–
const VRMAvatar3D = React.memo(({ vrm, pose }: Props) => {
  // ä½¿ç”¨ ref é¿å…é‡æ¸²æŸ“
  const vrmRef = useRef<VRM>(vrm);
  
  // ç¼“å­˜è®¡ç®—ç»“æœ
  const normalizedVRM = useMemo(() => {
    return normalizeVRM(vrm);
  }, [vrm]);
  
  // ä¼˜åŒ–çš„ frame å¾ªç¯
  useFrame((state, delta) => {
    if (!shouldUpdate(delta)) return; // è·³å¸§ä¼˜åŒ–
    applyPoseToVRM(vrmRef.current, pose);
  });
  
  return <primitive object={normalizedVRM} />;
});

// âŒ é¿å…çš„åšæ³•
function VRMAvatar3D({ vrm, pose }: Props) {
  // æ²¡æœ‰ memoï¼Œæ¯æ¬¡çˆ¶ç»„ä»¶æ›´æ–°éƒ½é‡æ¸²æŸ“ï¼
  // æ²¡æœ‰ç¼“å­˜ï¼Œæ¯å¸§é‡æ–°è®¡ç®—ï¼
}
```

**å¿…é¡»åŒ…å«**ï¼š
- `React.memo` åŒ…è£¹
- `useMemo` ç¼“å­˜è®¡ç®—
- `useRef` å­˜å‚¨ Three.js å¯¹è±¡
- æ€§èƒ½ä¼˜åŒ–æ³¨é‡Š

---

### 4. UI ç»„ä»¶è§„èŒƒ

**ä½ç½®**ï¼š`components/dressing-room/` æˆ– `components/ui/`

**è¦æ±‚**ï¼š
- ä¸ 3D é€»è¾‘å®Œå…¨åˆ†ç¦»
- é€šè¿‡ Context æˆ– props æ¥æ”¶çŠ¶æ€
- ä¸ç›´æ¥æ“ä½œ Three.js å¯¹è±¡
- ä¸åŒ…å«åŠ¨æ•å¤„ç†é€»è¾‘

```typescript
// âœ… å¥½çš„ UI ç»„ä»¶
function ModelSelector({ onModelSelect }: Props) {
  // åªè´Ÿè´£ UI äº¤äº’
  const handleSelect = (modelUrl: string) => {
    onModelSelect(modelUrl); // é€šè¿‡ callback å‘ä¸Šä¼ é€’
  };
  
  return <Select onValueChange={handleSelect}>...</Select>;
}

// âŒ é¿å…çš„åšæ³•
function ModelSelector() {
  // ç›´æ¥æ“ä½œ Three.jsï¼
  const scene = useThree();
  const loadModel = () => {
    scene.add(newModel); // è¿åå…³æ³¨ç‚¹åˆ†ç¦»ï¼
  };
}
```

---

### 5. Hooks è§„èŒƒ

**å‘½åè§„åˆ™**ï¼š
```
use + åŠŸèƒ½é¢†åŸŸ + å…·ä½“åŠŸèƒ½

âœ… useCameraStream.ts
âœ… useMocapPipeline.ts
âœ… useVRMNormalizer.ts
âœ… useCoordinateSystemDetection.ts

âŒ useData.ts (å¤ªæ³›åŒ–)
âŒ useVRM.ts (ä¸å¤Ÿå…·ä½“)
```

**ç»“æ„è¦æ±‚**ï¼š
```typescript
export function useMocapPipeline(config: MocapConfig) {
  // 1. é”™è¯¯çŠ¶æ€
  const [error, setError] = useState<Error | null>(null);
  
  // 2. ä½¿ç”¨ ref å­˜å‚¨ä¸éœ€è¦è§¦å‘é‡æ¸²æŸ“çš„æ•°æ®
  const poseDataRef = useRef<PoseData | null>(null);
  
  // 3. æ¸…ç†é€»è¾‘
  useEffect(() => {
    return () => {
      cleanup();
    };
  }, []);
  
  // 4. è¿”å›æ˜ç¡®çš„æ¥å£
  return {
    isActive: boolean,
    start: () => void,
    stop: () => void,
    currentPose: PoseData | null,
    error: Error | null,
  };
}
```

**å¿…é¡»åŒ…å«**ï¼š
- æ˜ç¡®çš„è¿”å›ç±»å‹å®šä¹‰
- é”™è¯¯å¤„ç†
- æ¸…ç†é€»è¾‘ï¼ˆcleanupï¼‰
- JSDoc æ³¨é‡Š

---

## ğŸ® VRM æœå‘ä¿®å¤ç­–ç•¥ï¼ˆé‡è¦ï¼‰

### é—®é¢˜åˆ†æ

**ç°è±¡**ï¼šç”¨æˆ·ä¸Šä¼ çš„ VRM æ¨¡å‹å‡ºç°ï¼š
1. çœ‹åˆ°çš„æ˜¯æ¨¡å‹åèƒŒ
2. æ‰‹è‡‚åŠ¨ä½œæ–¹å‘é”™è¯¯
3. å¤´éƒ¨æ—‹è½¬ç›¸å

**æ ¹æœ¬åŸå› **ï¼š
```
VRM è§„èŒƒç‰ˆæœ¬å·®å¼‚ï¼š

VRM 0.x: è§„èŒƒè¦æ±‚é¢æœ -Zï¼ˆå‘å±å¹•å¤–ï¼‰
VRM 1.0: è§„èŒƒæ”¹ä¸ºé¢æœ +Zï¼ˆå‘å±å¹•å†…ï¼‰

å¦‚æœä»£ç å‡è®¾æ˜¯ VRM 1.0ï¼ŒåŠ è½½ VRM 0.x å°±ä¼šçœ‹åˆ°åèƒŒ
```

### âœ… æ¨èè§£å†³æ–¹æ¡ˆï¼ˆåº“è‡ªå¸¦ï¼‰

**@pixiv/three-vrm æä¾›äº† `VRMUtils.rotateVRM0()` å‡½æ•°ï¼Œä¸“é—¨å¤„ç† VRM 0.x å’Œ VRM 1.0 çš„æœå‘å·®å¼‚ï¼š**

```typescript
import { VRMUtils } from '@pixiv/three-vrm';

const vrm = await loadVRM(file);

// âœ… åªåŠ è¿™ä¸€è¡Œå°±å¤Ÿäº†ï¼
VRMUtils.rotateVRM0(vrm);
```

**å®ç°ä½ç½®**ï¼š
åœ¨ `VRMAvatar.tsx` çš„ VRM åˆå§‹åŒ– `useEffect` ä¸­ï¼š

```typescript
// åˆå§‹åŒ– VRM æ¨¡å‹
useEffect(() => {
  if (!vrm) return;

  // âœ… ä¿®å¤ VRM 0.x å’Œ VRM 1.0 çš„æœå‘å·®å¼‚
  VRMUtils.rotateVRM0(vrm);

  // VRM ä¼˜åŒ–
  VRMUtils.removeUnnecessaryVertices(scene);
  VRMUtils.combineSkeletons(scene);
  VRMUtils.combineMorphs(vrm);
  
  // ... å…¶ä»–åˆå§‹åŒ–ä»£ç 
}, [vrm, scene]);
```

### âš ï¸ é‡è¦è¯´æ˜

**`axis-mapping.ts` å’Œ `axisSettings` çš„ä½œç”¨**ï¼š
- **ä¸æ˜¯**ç”¨æ¥ä¿®å¤æ¨¡å‹æœå‘çš„
- **æ˜¯**ç”¨æ¥è½¬æ¢åŠ¨æ•æ•°æ®åˆ° VRM éª¨éª¼æ—‹è½¬çš„
- å¦‚æœé€šè¿‡æ˜ å°„æ¥"ä¿®å¤"æœå‘ï¼Œé‚£æ˜¯åœ¨æ©ç›–é—®é¢˜

**æ­£ç¡®åšæ³•**ï¼š
1. âœ… ä½¿ç”¨ `VRMUtils.rotateVRM0(vrm)` ä¿®å¤æ¨¡å‹æœå‘ï¼ˆVRM 0.x/1.0 å·®å¼‚ï¼‰
2. âœ… ä½¿ç”¨ `axisSettings` è°ƒæ•´åŠ¨æ•æ•°æ®åˆ°éª¨éª¼çš„æ˜ å°„ï¼ˆä¸åŒæ¨¡å‹çš„éª¨éª¼æ—‹è½¬å·®å¼‚ï¼‰

### å…¶ä»–åæ ‡ç³»é—®é¢˜ï¼ˆä¸å¸¸è§ï¼‰

å¦‚æœé‡åˆ°æ¥è‡ªå…¶ä»– 3D è½¯ä»¶ï¼ˆBlenderã€Unityï¼‰çš„æ¨¡å‹ä»æœ‰æœå‘é—®é¢˜ï¼Œå¯èƒ½éœ€è¦é¢å¤–å¤„ç†ï¼Œä½†é¦–å…ˆç¡®ä¿å·²ç»ä½¿ç”¨äº† `VRMUtils.rotateVRM0()`ã€‚

### å®ç°ç»†èŠ‚ï¼ˆå·²å¼ƒç”¨ï¼Œä»…ä¾›å‚è€ƒï¼‰

#### 1. åæ ‡ç³»æ£€æµ‹ç®—æ³•

**æ–‡ä»¶**ï¼š`lib/vrm/inspector.ts`

```typescript
export function detectCoordinateSystem(vrm: VRM): CoordinateSystemInfo {
  const info: CoordinateSystemInfo = {
    system: VRMCoordinateSystem.Unknown,
    confidence: 0,
    needsRotation: false,
    suggestedFix: null
  };
  
  // æ£€æµ‹ 1: æ£€æŸ¥ VRM meta æ•°æ®
  const meta = vrm.meta;
  if (meta?.generator?.includes('VRoidStudio')) {
    info.system = VRMCoordinateSystem.VRoid;
    info.confidence = 0.9;
  }
  
  // æ£€æµ‹ 2: åˆ†æå¤´éƒ¨éª¨éª¼ä½ç½®
  const head = vrm.humanoid.getNormalizedBoneNode('head');
  if (head) {
    const headPos = new Vector3();
    head.getWorldPosition(headPos);
    
    // å¤´åº”è¯¥åœ¨ Y è½´æ­£æ–¹å‘
    if (headPos.y < 0) {
      info.needsRotation = true;
      info.suggestedFix = new Euler(Math.PI, 0, 0);
    }
  }
  
  // æ£€æµ‹ 3: T-pose æ£€æµ‹ï¼ˆå·¦å³æ‰‹åº”è¯¥åœ¨ X è½´æ­£è´Ÿæ–¹å‘ï¼‰
  const leftHand = vrm.humanoid.getNormalizedBoneNode('leftHand');
  const rightHand = vrm.humanoid.getNormalizedBoneNode('rightHand');
  
  if (leftHand && rightHand) {
    const leftPos = new Vector3();
    const rightPos = new Vector3();
    leftHand.getWorldPosition(leftPos);
    rightHand.getWorldPosition(rightPos);
    
    // å·¦æ‰‹åº”è¯¥åœ¨ -Xï¼Œå³æ‰‹åœ¨ +X
    if (leftPos.x > rightPos.x) {
      info.needsRotation = true;
      info.suggestedFix = new Euler(0, Math.PI, 0);
    }
  }
  
  // æ£€æµ‹ 4: é¢æœæ–¹å‘ï¼ˆç›¸æœºåº”è¯¥çœ‹åˆ°æ­£é¢ï¼‰
  const hips = vrm.humanoid.getNormalizedBoneNode('hips');
  if (hips) {
    const forward = new Vector3(0, 0, 1);
    hips.getWorldDirection(forward);
    
    // å¦‚æœ Z æ–¹å‘æ˜¯æ­£çš„ï¼Œå¯èƒ½é¢æœåæ–¹
    if (forward.z > 0.5) {
      info.needsRotation = true;
      info.suggestedFix = new Euler(0, Math.PI, 0);
    }
  }
  
  return info;
}
```

#### 2. å½’ä¸€åŒ–è½¬æ¢å™¨

**æ–‡ä»¶**ï¼š`lib/vrm/normalizer.ts`

```typescript
export function normalizeToStandard(
  vrm: VRM, 
  sourceSystem: VRMCoordinateSystem
): VRM {
  const scene = vrm.scene;
  
  // è½¬æ¢çŸ©é˜µæ˜ å°„
  const transforms: Record<VRMCoordinateSystem, Matrix4> = {
    [VRMCoordinateSystem.VRoid]: new Matrix4().identity(),
    
    [VRMCoordinateSystem.Blender_ZUp]: new Matrix4()
      .makeRotationX(-Math.PI / 2), // Z-up è½¬ Y-up
    
    [VRMCoordinateSystem.Unity]: new Matrix4()
      .makeRotationY(Math.PI), // å·¦æ‰‹ç³»è½¬å³æ‰‹ç³»
    
    [VRMCoordinateSystem.Standard]: new Matrix4().identity(),
  };
  
  const transform = transforms[sourceSystem];
  
  // åº”ç”¨å˜æ¢åˆ°æ ¹èŠ‚ç‚¹
  scene.applyMatrix4(transform);
  
  // é‡è¦ï¼šæ›´æ–°æ‰€æœ‰å­èŠ‚ç‚¹çš„ä¸–ç•ŒçŸ©é˜µ
  scene.updateMatrixWorld(true);
  
  return vrm;
}
```

#### 3. ç”¨æˆ·ç•Œé¢ç»„ä»¶

**æ–‡ä»¶**ï¼š`components/debug/VRMInspector.tsx`

```typescript
export function VRMInspector({ vrm }: Props) {
  const [info, setInfo] = useState<CoordinateSystemInfo | null>(null);
  const [manualSystem, setManualSystem] = useState<VRMCoordinateSystem | null>(null);
  
  useEffect(() => {
    if (vrm) {
      const detected = detectCoordinateSystem(vrm);
      setInfo(detected);
    }
  }, [vrm]);
  
  return (
    <Card>
      <CardHeader>
        <CardTitle>æ¨¡å‹åæ ‡ç³»æ£€æŸ¥</CardTitle>
      </CardHeader>
      <CardContent>
        {/* æ£€æµ‹ç»“æœ */}
        <div>
          <p>æ£€æµ‹åˆ°çš„åæ ‡ç³»: {info?.system}</p>
          <p>ç½®ä¿¡åº¦: {(info?.confidence ?? 0) * 100}%</p>
          
          {info?.needsRotation && (
            <Alert>
              <AlertTitle>éœ€è¦ä¿®å¤</AlertTitle>
              <AlertDescription>
                æ¨¡å‹æœå‘å¯èƒ½ä¸æ­£ç¡®ï¼Œå»ºè®®åº”ç”¨æ—‹è½¬ä¿®å¤
              </AlertDescription>
            </Alert>
          )}
        </div>
        
        {/* æ‰‹åŠ¨è¦†ç›–é€‰é¡¹ */}
        <div className="mt-4">
          <Label>æ‰‹åŠ¨é€‰æ‹©åæ ‡ç³»:</Label>
          <Select onValueChange={setManualSystem}>
            <SelectItem value="vroid">VRoid Studio</SelectItem>
            <SelectItem value="blender-z">Blender (Z-up)</SelectItem>
            <SelectItem value="unity">Unity</SelectItem>
            <SelectItem value="standard">æ ‡å‡† VRM</SelectItem>
          </Select>
        </div>
        
        {/* å®æ—¶é¢„è§ˆ */}
        <div className="mt-4">
          <Canvas>
            <VRMPreview vrm={vrm} rotation={info?.suggestedFix} />
          </Canvas>
        </div>
      </CardContent>
    </Card>
  );
}
```

### é…ç½®æ–‡ä»¶

**æ–‡ä»¶**ï¼š`config/coordinate-systems.ts`

```typescript
export const COORDINATE_SYSTEM_CONFIGS = {
  vroid: {
    name: 'VRoid Studio',
    handedness: 'right',
    upAxis: 'Y',
    forwardAxis: '-Z',
    rotationOffset: new Euler(0, 0, 0),
    needsNormalization: false,
  },
  
  'blender-z': {
    name: 'Blender (Z-up)',
    handedness: 'right',
    upAxis: 'Z',
    forwardAxis: '+Y',
    rotationOffset: new Euler(-Math.PI / 2, 0, 0),
    needsNormalization: true,
  },
  
  unity: {
    name: 'Unity',
    handedness: 'left',
    upAxis: 'Y',
    forwardAxis: '+Z',
    rotationOffset: new Euler(0, Math.PI, 0),
    needsNormalization: true,
  },
  
  standard: {
    name: 'VRM Standard',
    handedness: 'right',
    upAxis: 'Y',
    forwardAxis: '-Z',
    rotationOffset: new Euler(0, 0, 0),
    needsNormalization: false,
  },
} as const;
```

---

## ğŸš« ç¦æ­¢äº‹é¡¹

### ç»å¯¹ç¦æ­¢
- âŒ åœ¨ React ç»„ä»¶ä¸­ç›´æ¥è°ƒç”¨ MediaPipe
- âŒ åœ¨ `useFrame` å›è°ƒä¸­ä½¿ç”¨ `setState`
- âŒ ç¡¬ç¼–ç åæ ‡æ˜ å°„æ•°å€¼ï¼ˆåº”ä½¿ç”¨é…ç½®æˆ–è‡ªåŠ¨æ£€æµ‹ï¼‰
- âŒ åœ¨åŠ¨æ•å¾ªç¯ä¸­ä½¿ç”¨ `console.log`
- âŒ æ··åˆ UI é€»è¾‘å’Œ 3D é€»è¾‘åœ¨åŒä¸€æ–‡ä»¶
- âŒ ä¸å¤„ç† VRM 0.x/1.0 æœå‘å·®å¼‚ç›´æ¥åº”ç”¨åŠ¨æ•æ•°æ®ï¼ˆåº”ä½¿ç”¨ `VRMUtils.rotateVRM0()`ï¼‰

### åº”å½“é¿å…
- âš ï¸ è¿‡åº¦ä¾èµ–å›ºå®šçš„åæ ‡è½´æ˜ å°„é…ç½®
- âš ï¸ å‡è®¾æ‰€æœ‰ VRM æ¨¡å‹ä½¿ç”¨ç›¸åŒåæ ‡ç³»ï¼ˆVRM 0.x å’Œ 1.0 æœå‘ä¸åŒï¼‰
- âš ï¸ æ²¡æœ‰é”™è¯¯å¤„ç†çš„å¼‚æ­¥æ“ä½œ
- âš ï¸ è¶…è¿‡ 300 è¡Œçš„ç»„ä»¶æ–‡ä»¶

---

## ğŸ“ å‘½åçº¦å®š

### ç»„ä»¶
- 3D ç›¸å…³ç»„ä»¶ï¼š`*3D.tsx` (VRMAvatar3D.tsx)
- è°ƒè¯•é¢æ¿ï¼š`*DebugPanel.tsx` (CoordinateDebugPanel.tsx)
- æ£€æŸ¥å™¨ï¼š`*Inspector.tsx` (VRMInspector.tsx)

### æ–‡ä»¶
- å¤„ç†å™¨ï¼š`*Processor.ts` (PoseProcessor.ts)
- å½’ä¸€åŒ–å™¨ï¼š`*Normalizer.ts` (VRMNormalizer.ts)
- é…ç½®æ–‡ä»¶ï¼š`*.config.ts` (vrm.config.ts)

### å‡½æ•°
- å·¥å…·å‡½æ•°ï¼šåŠ¨è¯å¼€å¤´ (transformCoord, detectSystem, normalizeVRM)
- æ£€æµ‹å‡½æ•°ï¼š`detect*` (detectCoordinateSystem)
- è½¬æ¢å‡½æ•°ï¼š`normalize*` æˆ– `transform*`

### ç±»å‹
- æšä¸¾ï¼šPascalCase (VRMCoordinateSystem)
- æ¥å£ï¼šPascalCase (CoordinateSystemInfo)
- ç±»å‹åˆ«åï¼šPascalCase (TransformedPose)

---

## ğŸ’¬ æ³¨é‡Šè¦æ±‚

### å¿…é¡»æ·»åŠ æ³¨é‡Šçš„åœºæ™¯

1. **åæ ‡è½¬æ¢ä»£ç **ï¼š
```typescript
// è½¬æ¢ Blender Z-up åæ ‡ç³»åˆ° VRM æ ‡å‡† Y-up
// Blender: Z-up, å³æ‰‹ç³», é¢æœ +Y
// VRM:    Y-up, å³æ‰‹ç³», é¢æœ -Z
// å˜æ¢: ç»• X è½´æ—‹è½¬ -90Â°
const transform = new Matrix4().makeRotationX(-Math.PI / 2);
```

2. **æ€§èƒ½æ•æ„Ÿä»£ç **ï¼š
```typescript
// PERF: ä½¿ç”¨å¯¹è±¡æ± é¿å…æ¯å¸§åˆ›å»º 1000+ å¯¹è±¡
private poseCache: PoseData[] = Array(1000).fill(null).map(() => ({}));
```

3. **MediaPipe æ•°æ®å¤„ç†**ï¼š
```typescript
// MediaPipe è¾“å‡ºæ ¼å¼:
// landmarks: Array<{x: 0-1, y: 0-1, z: -1 to 1, visibility: 0-1}>
// x, y æ˜¯å½’ä¸€åŒ–çš„å±å¹•åæ ‡
// z æ˜¯ç›¸å¯¹æ·±åº¦ï¼ˆä¸æ˜¯çœŸå®ä¸–ç•Œåæ ‡ï¼‰
```

4. **å¤æ‚çš„ Three.js æ“ä½œ**ï¼š
```typescript
// æ­¥éª¤:
// 1. è·å–éª¨éª¼çš„ä¸–ç•Œåæ ‡
// 2. è½¬æ¢åˆ°æœ¬åœ°ç©ºé—´
// 3. åº”ç”¨å››å…ƒæ•°æ—‹è½¬
// 4. æ›´æ–°çŸ©é˜µ
```

5. **åæ ‡ç³»æ£€æµ‹é€»è¾‘**ï¼š
```typescript
// æ£€æµ‹ä¾æ®:
// - å¤´éƒ¨åº”è¯¥åœ¨ Y è½´æ­£æ–¹å‘ï¼ˆY > 0ï¼‰
// - å·¦æ‰‹åœ¨ X è½´è´Ÿæ–¹å‘ï¼ˆX < 0ï¼‰
// - é¢æœæ–¹å‘åº”è¯¥æ˜¯ -Zï¼ˆforward.z < 0ï¼‰
```

---

## ğŸ¯ çŠ¶æ€ç®¡ç†ç­–ç•¥

### çŠ¶æ€åˆ†ç±»

```typescript
// 1. å…¨å±€åº”ç”¨çŠ¶æ€ - ä½¿ç”¨ Context
interface VTuberGlobalState {
  currentVRM: VRM | null;
  coordinateSystem: VRMCoordinateSystem;
  isCameraActive: boolean;
  isMocapActive: boolean;
}

// 2. 3D åœºæ™¯çŠ¶æ€ - ä½¿ç”¨ Zustand æˆ– useRef
interface SceneState {
  vrm: VRM;
  normalizedVRM: VRM;
  camera: PerspectiveCamera;
}

// 3. UI çŠ¶æ€ - ä½¿ç”¨ useState
interface UIState {
  isModelManagerOpen: boolean;
  isDebugPanelVisible: boolean;
}

// 4. åŠ¨æ•æ•°æ® - ä½¿ç”¨ useRefï¼ˆé¿å…é‡æ¸²æŸ“ï¼‰
interface MocapData {
  pose: PoseData;
  hands: HandData;
  face: FaceData;
}
```

### ä½¿ç”¨åŸåˆ™

```typescript
// âœ… æ­£ç¡®ä½¿ç”¨
const SceneComponent = () => {
  // åŠ¨æ•æ•°æ®ä¸éœ€è¦è§¦å‘é‡æ¸²æŸ“
  const mocapRef = useRef<MocapData>(null);
  
  useFrame(() => {
    // æ¯å¸§è¯»å–ï¼Œä½†ä¸è§¦å‘ç»„ä»¶æ›´æ–°
    applyMocapData(vrm, mocapRef.current);
  });
};

// âŒ é”™è¯¯ä½¿ç”¨
const SceneComponent = () => {
  // æ¯å¸§æ›´æ–°ä¼šè§¦å‘æ•´ä¸ªç»„ä»¶æ ‘é‡æ¸²æŸ“ï¼
  const [mocapData, setMocapData] = useState<MocapData>(null);
  
  useFrame(() => {
    setMocapData(newData); // ç¾éš¾ï¼
  });
};
```

---

## ğŸ”§ å›½é™…åŒ–è§„åˆ™

### ç¿»è¯‘ key ç»“æ„
```
åŠŸèƒ½.ç»„ä»¶.æ–‡æœ¬

ç¤ºä¾‹:
mocap.camera.enable
vrm.inspector.coordinateSystem
vrm.inspector.detectedSystem
vrm.inspector.manualOverride
debug.panel.performance
```

### ä½¿ç”¨ç¤ºä¾‹
```typescript
import { useTranslations } from 'next-intl';

function VRMInspector() {
  const t = useTranslations('vrm.inspector');
  
  return (
    <div>
      <h3>{t('title')}</h3>
      <p>{t('detectedSystem', { system: 'VRoid' })}</p>
    </div>
  );
}
```

### ç¦æ­¢ç¡¬ç¼–ç 
```typescript
// âŒ é”™è¯¯
<Button>Enable Camera</Button>

// âœ… æ­£ç¡®
<Button>{t('mocap.camera.enable')}</Button>
```

---

## ğŸ“Š æ€§èƒ½æ£€æŸ¥æ¸…å•

### æ¯æ¬¡ Commit å‰æ£€æŸ¥

```bash
# 1. ç±»å‹æ£€æŸ¥
pnpm typecheck

# 2. æ£€æŸ¥æ˜¯å¦æœ‰ç¡¬ç¼–ç åæ ‡å€¼ï¼ˆåº”è¯¥ç§»é™¤æˆ–ç”¨é…ç½®æ›¿ä»£ï¼‰
grep -r "{ x: -1, y: 1" src/components/ || echo "âœ… æ— ç¡¬ç¼–ç "

# 3. æ£€æŸ¥æ€§èƒ½æ³¨é‡Š
grep -r "// PERF:" src/lib/mocap/ || echo "âš ï¸ ç¼ºå°‘æ€§èƒ½æ³¨é‡Š"

# 4. æ£€æŸ¥æ˜¯å¦æœ‰åæ ‡ç³»å¤„ç†
grep -r "normalizeVRM\|detectCoordinateSystem" src/ || echo "âš ï¸ å¯èƒ½ç¼ºå°‘åæ ‡å½’ä¸€åŒ–"

# 5. æ ¼å¼åŒ–
pnpm format
```

### è¿è¡Œæ—¶æ€§èƒ½ç›‘æ§

```typescript
// åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨
if (process.env.NODE_ENV === 'development') {
  // ç›‘æ§å¸§ç‡
  const stats = new Stats();
  document.body.appendChild(stats.dom);
  
  // ç›‘æ§å†…å­˜
  console.log('Memory:', performance.memory);
}
```

---

## ğŸ“ å…³äºåæ ‡æ˜ å°„çš„å»ºè®®

### å½“å‰ç­–ç•¥
**åæ ‡æ˜ å°„é…ç½® (`config/axis-mapping.ts`) å¯èƒ½æ˜¯ä¸å¿…è¦çš„ï¼**

### åŸå› åˆ†æ
```
é—®é¢˜æ ¹æºä¸æ˜¯"æ˜ å°„"ï¼Œè€Œæ˜¯"å½’ä¸€åŒ–"

é”™è¯¯æ€è·¯ï¼š
  ä¸ºæ¯ç§æ¨¡å‹é…ç½®ä¸åŒçš„æ˜ å°„è§„åˆ™ âŒ

æ­£ç¡®æ€è·¯ï¼š
  1. æ£€æµ‹æ¨¡å‹å½“å‰åæ ‡ç³»
  2. å½’ä¸€åŒ–åˆ°ç»Ÿä¸€æ ‡å‡†
  3. ä½¿ç”¨ç»Ÿä¸€çš„åŠ¨æ•åº”ç”¨é€»è¾‘ âœ…
```

### é‡æ„å»ºè®®

#### é˜¶æ®µ 1: ä¿ç•™æ˜ å°„é…ç½®ï¼ˆå…œåº•ï¼‰
```typescript
// ä»ç„¶ä¿ç•™ä½œä¸ºå…œåº•æ–¹æ¡ˆ
export const LEGACY_AXIS_MAPPING = {
  // æŸäº›ç‰¹æ®Šæƒ…å†µå¯èƒ½éœ€è¦
};
```

#### é˜¶æ®µ 2: å®ç°å½’ä¸€åŒ–ç³»ç»Ÿ
```typescript
// æ–°çš„ä¸»è¦é€»è¾‘
export function prepareVRMForMocap(vrm: VRM): VRM {
  // 1. æ£€æµ‹åæ ‡ç³»
  const system = detectCoordinateSystem(vrm);
  
  // 2. å½’ä¸€åŒ–
  const normalized = normalizeToStandard(vrm, system);
  
  // 3. éªŒè¯
  const validation = validateVRMOrientation(normalized);
  if (!validation.isCorrect) {
    // å›é€€åˆ°æ‰‹åŠ¨ä¿®å¤æˆ–ç”¨æˆ·é€‰æ‹©
  }
  
  return normalized;
}
```

#### é˜¶æ®µ 3: ç§»é™¤æ—§é…ç½®
```typescript
// å¦‚æœå½’ä¸€åŒ–ç³»ç»Ÿç¨³å®šè¿è¡Œï¼Œå¯ä»¥ç§»é™¤
// config/axis-mapping.ts (deprecated)
```

---

## ğŸ› å·²çŸ¥é—®é¢˜å’Œä¸´æ—¶æ–¹æ¡ˆ

### é—®é¢˜ 1: æ‰‹æŒ‡æ˜ å°„ä¸å‡†ç¡®
**çŠ¶æ€**: è°ƒè¯•ä¸­  
**ä¸´æ—¶æ–¹æ¡ˆ**: æä¾›æ‰‹åŠ¨è°ƒæ•´ç•Œé¢  
**é•¿æœŸæ–¹æ¡ˆ**: å®ç°åŸºäºæœºå™¨å­¦ä¹ çš„è‡ªåŠ¨æ ¡å‡†

### é—®é¢˜ 2: è¯­è¨€åˆ‡æ¢ä¸å·¥ä½œ
**çŠ¶æ€**: å¾…ä¿®å¤  
**åŸå› **: next-intl é…ç½®é—®é¢˜  
**ä¼˜å…ˆçº§**: ä¸­

### é—®é¢˜ 3: æ¨¡å‹æœå‘ä¸ä¸€è‡´ï¼ˆå·²è§£å†³ï¼‰
**çŠ¶æ€**: âœ… å·²ä¿®å¤  
**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ `VRMUtils.rotateVRM0(vrm)`  
**è¯´æ˜**: è¿™æ˜¯åº“è‡ªå¸¦çš„è§£å†³æ–¹æ¡ˆï¼Œä¸“é—¨å¤„ç† VRM 0.x å’Œ 1.0 çš„æœå‘å·®å¼‚

---

## ğŸ“š å‚è€ƒèµ„æº

### VRM è§„èŒƒ
- VRM å®˜æ–¹æ–‡æ¡£: https://vrm.dev/
- VRM åæ ‡ç³»æ ‡å‡†: å³æ‰‹ç³»ï¼ŒY-upï¼Œé¢æœ -Z

### Three.js
- åæ ‡ç³»: å³æ‰‹ç³»ï¼ŒY-up
- æ€§èƒ½ä¼˜åŒ–: https://threejs.org/manual/#en/optimize

### MediaPipe
- Pose: https://google.github.io/mediapipe/solutions/pose
- Hands: https://google.github.io/mediapipe/solutions/hands

---

## ğŸ”„ ç‰ˆæœ¬å†å²

### v2.0 (å½“å‰)
- âœ… ä½¿ç”¨ `VRMUtils.rotateVRM0()` ä¿®å¤ VRM 0.x/1.0 æœå‘å·®å¼‚
- âœ… æ˜ç¡® `axisSettings` çš„ä½œç”¨ï¼ˆåŠ¨æ•æ•°æ®æ˜ å°„ï¼Œä¸æ˜¯æœå‘ä¿®å¤ï¼‰
- ğŸ”„ ç®€åŒ–åæ ‡ç³»å¤„ç†ç­–ç•¥ï¼Œä¼˜å…ˆä½¿ç”¨åº“è‡ªå¸¦è§£å†³æ–¹æ¡ˆ

### v1.0
- âœ… åŸºç¡€åŠ¨æ•åŠŸèƒ½
- âœ… åæ ‡è½´è°ƒè¯•é¢æ¿
- âš ï¸ ç¡¬ç¼–ç çš„åæ ‡æ˜ å°„ï¼ˆå¾…åºŸå¼ƒï¼‰

---

## ğŸ’¡ å¼€å‘æç¤º

### ä¸ Cursor AI åä½œæ—¶

**æ˜ç¡®æ•°æ®æµ**ï¼š
```
æˆ‘è¦ä¿®æ”¹ [åŠŸèƒ½]
æ•°æ®æµ: Camera â†’ MediaPipe â†’ Kalidokit â†’ VRM
ä¿®æ”¹ä½ç½®: [å…·ä½“ç¯èŠ‚]
ä¸æ”¹å˜: [ä¸Šæ¸¸/ä¸‹æ¸¸]
```

**æ˜ç¡®åæ ‡ç³»å¤„ç†**ï¼š
```
å¤„ç† VRM æ¨¡å‹åŠ è½½

æ­¥éª¤:
1. åŠ è½½åŸå§‹ VRM
2. æ£€æµ‹åæ ‡ç³» (detectCoordinateSystem)
3. å½’ä¸€åŒ– (normalizeToStandard)
4. éªŒè¯æœå‘
5. åº”ç”¨åŠ¨æ•æ•°æ®

åªä¿®æ”¹ lib/vrm/loader.ts
```

**æ€§èƒ½ä¼˜åŒ–æé†’**ï¼š
```
ä¼˜åŒ– [åŠŸèƒ½] æ€§èƒ½

è¦æ±‚:
- ä½¿ç”¨å¯¹è±¡æ± 
- é¿å…æ¯å¸§åˆ›å»ºå¯¹è±¡
- æ·»åŠ  PERF æ³¨é‡Š
- æµ‹é‡ä¼˜åŒ–å‰å FPS
```

---

## âœ… ä»£ç å®¡æŸ¥æ ‡å‡†

### Pull Request å¿…é¡»æ»¡è¶³

- [ ] é€šè¿‡ TypeScript ç±»å‹æ£€æŸ¥
- [ ] é€šè¿‡ä»£ç æ ¼å¼æ£€æŸ¥
- [ ] æ€§èƒ½æ•æ„Ÿä»£ç æœ‰ PERF æ³¨é‡Š
- [ ] VRM å¤„ç†åŒ…å«åæ ‡ç³»æ£€æµ‹
- [ ] å›½é™…åŒ–æ–‡æœ¬ä½¿ç”¨ç¿»è¯‘ key
- [ ] æ²¡æœ‰ console.logï¼ˆé™¤äº†é”™è¯¯æ—¥å¿—ï¼‰
- [ ] Three.js ç»„ä»¶ä½¿ç”¨ React.memo
- [ ] åŠ¨æ•å¾ªç¯ä¸è§¦å‘çŠ¶æ€æ›´æ–°

### æ€§èƒ½è¦æ±‚

- [ ] åŠ¨æ•è¿è¡Œåœ¨ 60fps
- [ ] æ¨¡å‹åŠ è½½æ—¶é—´ < 3 ç§’
- [ ] å†…å­˜ä½¿ç”¨ç¨³å®šï¼ˆæ— æ³„æ¼ï¼‰
- [ ] å¸§ç‡æ³¢åŠ¨ < 10%

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### å·²å®Œæˆ
1. âœ… ä½¿ç”¨ `VRMUtils.rotateVRM0()` ä¿®å¤ VRM 0.x/1.0 æœå‘å·®å¼‚
2. âœ… æ˜ç¡®åæ ‡æ˜ å°„é…ç½®çš„çœŸå®ç”¨é€”

### çŸ­æœŸè®¡åˆ’ï¼ˆæœ¬æœˆï¼‰
1. å®Œå–„è‡ªåŠ¨æ£€æµ‹ç®—æ³•
2. æ”¶é›†ä¸åŒæ¥æº VRM æ ·æœ¬æµ‹è¯•
3. ä¼˜åŒ–ç”¨æˆ·ä½“éªŒæµç¨‹
4. ç¼–å†™å•å…ƒæµ‹è¯•

### é•¿æœŸè®¡åˆ’ï¼ˆå­£åº¦ï¼‰
1. æœºå™¨å­¦ä¹ è¾…åŠ©åæ ‡æ£€æµ‹
2. ç§»é™¤ç¡¬ç¼–ç çš„æ˜ å°„é…ç½®
3. æ€§èƒ½ä¼˜åŒ–åˆ° 120fps
4. å¤šç”¨æˆ·æµ‹è¯•å’Œåé¦ˆæ”¶é›†

